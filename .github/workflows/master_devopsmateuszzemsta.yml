# Workflow do deployu ASP.NET Core do Azure Web App
# Docs: https://github.com/Azure/webapps-deploy
# Więcej akcji Azure: https://github.com/Azure/actions

name: Deploy ASP.Net Core app to Azure Web App - devopsmateuszzemsta

# Wyzwalacz workflow
on:
  workflow_run:
    workflows: ["CI"]  # Nazwa Twojego workflow CI (build)
    types:
      - completed       # Ten workflow uruchomi się po zakończeniu CI

# Definicja joba deploy
jobs:
  deploy:
    runs-on: windows-latest   # Maszyna, na której będzie uruchamiany workflow
    permissions:
      id-token: write         # Potrzebne do uzyskania JWT dla Azure OIDC
      contents: read          # Potrzebne do checkout repozytorium (download artefaktów)

    steps:
      # 1️⃣ Pobranie artefaktów z joba build
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: .net-app     # Nazwa artefaktu, który był uploadowany w CI

      # 2️⃣ Logowanie do Azure
      - name: Login to Azure
        uses: azure/login@v2
        with:
          # Service Principal / Azure credentials przechowywane jako GitHub Secrets
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_99E47F5208134825B2F9CB3450E0B5F3 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_0EDA28F9D75F42AF8BD8299AAB5836D2 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_F91D6B37B88B447D87B3ECB83D7C4911 }}
        # Ten krok loguje GitHub Actions w Azure, dzięki czemu możemy deployować aplikację

      # 3️⃣ Deploy do Web App
      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'devopsmateuszzemsta'  # Nazwa Twojej Azure Web App
          slot-name: 'Production'          # Slot, do którego deployujemy (Production)
          package: .                        # Ścieżka do artefaktów do deployu (folder lub zip)
        # Ten krok wysyła naszą aplikację do Azure App Service
