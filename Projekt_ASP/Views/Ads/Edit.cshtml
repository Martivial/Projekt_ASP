@model Projekt_ASP.Models.Ad
@using System.Linq

<div class="container mt-5">
    <h2 class="text-center text-black">Edytuj Ogłoszenie</h2>
    <form asp-action="Edit" method="post" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="UserId" />

        <!-- Informacje o ogłoszeniu -->
        <div class="form-group">
            <label asp-for="Category" class="control-label text-black">Kategoria</label>
            <input asp-for="Category" class="form-control" readonly />
            <input type="hidden" asp-for="Category" />
            <span asp-validation-for="Category" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Title" class="control-label text-black">Tytuł</label>
            <input asp-for="Title" class="form-control" />
            <span asp-validation-for="Title" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Description" class="control-label text-black">Opis</label>
            <textarea asp-for="Description" class="form-control"></textarea>
            <span asp-validation-for="Description" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Price" class="control-label text-black">Cena</label>
            <input asp-for="Price" class="form-control" />
            <span asp-validation-for="Price" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Location" class="control-label text-black">Lokalizacja</label>
            <input asp-for="Location" class="form-control" />
            <span asp-validation-for="Location" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="PhoneNumber" class="control-label text-black">Numer telefonu</label>
            <input asp-for="PhoneNumber" class="form-control" />
            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
        </div>

        <!-- Dynamiczne pola (np. Pojazd, Nieruchomości, Praca, Elektronika) -->
        @if (!string.IsNullOrEmpty(Model.VehicleBrand) && Model.VehicleBrand != "Unknown")
        {
            <div class="form-group">
                <label asp-for="VehicleBrand" class="control-label text-black">Marka pojazdu</label>
                <input asp-for="VehicleBrand" class="form-control" />
                <span asp-validation-for="VehicleBrand" class="text-danger"></span>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.VehicleModel) && Model.VehicleModel != "Unknown")
        {
            <div class="form-group">
                <label asp-for="VehicleModel" class="control-label text-black">Model pojazdu</label>
                <input asp-for="VehicleModel" class="form-control" />
                <span asp-validation-for="VehicleModel" class="text-danger"></span>
            </div>
        }

        <!-- Wyświetlanie istniejących zdjęć -->
        <div class="form-group">
            <label class="text-black">Istniejące zdjęcia</label>
            <div class="row">
                @foreach (var image in Model.Images)
                {
                    var base64Image = Convert.ToBase64String(image.ImageData);
                    <div class="col-md-3" id="image-@image.Id">
                        <img src="data:image/jpeg;base64,@base64Image" class="img-thumbnail" style="max-height: 150px; object-fit: cover;" />
                        <input type="hidden" name="imageIds" value="@image.Id" />
                        <input type="file" name="imageFiles" class="form-control mt-2" />

                        <!-- Przycisk do usunięcia zdjęcia -->
                        <button type="button" class="btn btn-danger mt-2" onclick="deleteImage(@image.Id)">Usuń zdjęcie</button>
                    </div>
                }
            </div>
        </div>

        <!-- Dodaj nowe zdjęcia -->
        <div class="form-group">
            <label class="text-black">Dodaj nowe zdjęcia</label>
            <input type="file" name="newImages" class="form-control" multiple />
        </div>

        <!-- Spinner dla wskazówki ładowania -->
        <div id="loadingSpinner" style="display: none;">
            <img src="spinner.gif" alt="Ładowanie..." />
        </div>

        <!-- Zapisz ogłoszenie i anuluj -->
        <button type="submit" class="btn" style="background-color:#1d8968; color: white; margin-top: 20px;">Zapisz</button>
        <a asp-action="Index" class="btn btn-secondary mt-4" style="margin-top: 20px;">Anuluj</a>

    </form>
    <!-- Przycisk do usunięcia ogłoszenia -->
    <form asp-action="DeleteConfirmed" method="post" style="display: inline-block;">
        <input type="hidden" name="id" value="@Model.Id" />
        <button type="submit" class="btn" style="background-color: #dc3545; color: white; margin-top: 20px;" onclick="return confirm('Czy chcesz na pewno usunąć ogłoszenie?');">Usuń ogłoszenie</button>
    </form>
</div>

<script>
    // Funkcja JavaScript do obsługi usuwania zdjęcia
    function deleteImage(imageId) {
        if (confirm("Czy na pewno chcesz usunąć to zdjęcie?")) {
            const imageDiv = document.getElementById(`image-${imageId}`);
            imageDiv.style.display = "none"; // Ukryj zdjęcie tymczasowo

            // Opcjonalnie wyślij zapytanie AJAX w celu usunięcia zdjęcia z bazy danych

            // Przykład prostego zapytania AJAX (można zmodyfikować według potrzeb)
            fetch(`/Ad/DeleteImage/${imageId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Zdjęcie zostało usunięte.");
                    } else {
                        alert("Błąd podczas usuwania zdjęcia.");
                    }
                });
        }
    }
</script>

<style>
    /* Dodatkowe niestandardowe style */
    .container {
        background-color: #fff;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .form-group label {
        color: #000;
    }

    .form-control {
        border-radius: 5px;
        border: 1px solid #ddd;
    }

    .btn {
        font-size: 1rem;
        border-radius: 5px;
    }

    .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
    }

    .btn:hover {
        opacity: 0.8;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: #fff;
    }
</style>
